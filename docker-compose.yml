version: '3.3'
services:
  app:
    container_name: 'app'
    build: .
    command: gunicorn -w 2 -k uvicorn.workers.UvicornWorker fastapi_app.main:app --bind 0.0.0.0:40000 --timeout 1200  --forwarded-allow-ips='*'
    # command: uvicorn fastapi_app.main:app --host 0.0.0.0 --reload --port 40000 --forwarded-allow-ips='*' --proxy-headers
    restart: always
    environment:
      - PYTHONUNBUFFERED=1
      - PW=/run/secrets/pw
    ports:
      - '40000:40000'
    links:
      - mysql
    secrets:
      - pw
    depends_on:
      - redis
      - mysql
  mysql:
    container_name: mysql
    image: mysql
    restart: always
    environment:
      MYSQL_DATABASE: peoplesun_user_db
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/pw
    ports:
      - '40001:3306'
    secrets:
      - pw
  redis:
    image: redis
    container_name: 'redis'
    restart: always
    ports:
    - '6379:6379'
  worker:
    container_name: 'celery'
    build: .
    restart: always
    ports:
      - '5555:5555'
    command: celery -A celery_worker.worker worker --loglevel=INFO -P threads
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - FLOWER_PORT=5555
      - PW=/run/secrets/pw
    depends_on:
      - app
      - redis
      - mysql
    secrets:
      - pw
  flower:
    container_name: 'flower'
    build: .
    restart: always
    command: celery -A celery_worker.worker flower --port=5555
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - FLOWER_PORT=5555
      - PW=/run/secrets/pw
    ports:
      - '40002:5555'
    depends_on:
      - redis
      - worker
      - app
    secrets:
      - pw
secrets:
  pw:
    file: ./secrets/secret.txt
